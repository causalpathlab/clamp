---
title: "Finding causal variables using a linear regression based CLAMP model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{clamp-linear-causal}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, comment = "#>",
  fig.width = 5, fig.height = 4, fig.align = "center", fig.cap = "&nbsp;", 
  dpi = 120
)
```

```{r setup}
# library(clamp)
devtools::load_all(".")
library(matrixStats)
library(corrplot)
```


## An example

```{r}
set.seed(107107)
nn <- 800
# pp <- 1000
pp <- 20
U <- rnorm(nn)
zeta <- ((1:pp) -(pp/2+0.5)) / (pp+1)
# zeta <- rnorm(pp, sd = 1)
# zeta <- rep(0, times = pp)
# hist(zeta)
delta <- matrix(rnorm(nn*pp, 0, 0.1), nrow=nn)
UU <- (outer(U, zeta) + delta)[, , drop=F]

Pmat <- expit(UU)  # Prob matrix
hist(cor(Pmat), breaks = seq(-1, 1, by = 0.1))
corrplot(cor(Pmat), type = "upper")
```

```{r}
X <- sapply(1:pp, function(j) {rbinom(nn, 1, Pmat[,j])})
X <- apply(X, 2, as.double)
esp <- rnorm(nn)

causal_vars <- sample.int(pp, size = 3)
coefs <- rnorm(length(causal_vars) + 1)
# coefs <- rep(1, times = length(causal_vars) + 1)
y <- cbind(X[, causal_vars, drop=F], U) %*% as.matrix(coefs) + esp

print(data.frame(variable = c(paste0("X", causal_vars), "U"), 
                 effect_size = coefs))
```



### Step 1: estimate the propensity scores and construct the weight matrix

```{r estimate ps}
# PS <- matrix(nrow = nrow(X), ncol = ncol(X))
PS <- apply(X, 2, 
            function(xcol) predict(glm(xcol ~ U, family = binomial), type = "response"))
```

```{r}
hist(as.numeric(PS), main = "Estimated propensity")
# apply(PS, 2, function(x){sum(x<= 0.1 | x >= 0.9)})
range(PS)
```

```{r}
Wmat <- ifelse(X == 1, 1/PS, 1/(1-PS))
range(Wmat)
```

## Step 2: fit a clamp model

```{r}
res_cl <- clamp(X, y, W=Wmat, family = "linear", 
                # standardize = F, 
                # robust_method = "huber",
                verbose = T)
```

```{r}
clamp_plot(res_cl, y = "PIP", effect_indices = causal_vars)
summarize_coefficients(res_cl)
```


```{r}
plot(res_cl$elbo[-(1:5)], type = "o")
plot(res_cl$loglik[-(1:5)], type = "o")
```


### Compare with `susieR`

```{r}
res_su <- susieR::susie(X, y)
summarize_coefficients(res_su)
clamp_plot(res_su, y = "PIP", effect_indices = causal_vars)
```

### Compare with LASSO

```{r, message=F, warning=F}
library(tidyverse)
myPalette2 <- c("#E69F00", "#999999")
plot_select_results <- function(vals, effect_idx) {
  tibble(vals = vals) %>%
    mutate(id = 1 : n()) %>%
    mutate(true_label = if_else(id %in% effect_idx, "causal", "noncausal")) %>%
    arrange(desc(true_label)) %>%
    ggplot(aes(x = id, y = vals, color = as.factor(true_label))) +
    geom_point(size = 3) +
    scale_color_manual(values = myPalette2) +
    labs(x = "variable", color = "") +
    theme_classic()
}
```


```{r}
library(glmnet)
res_la <- cv.glmnet(X, y, family = "gaussian", alpha = 1)

plot_select_results(abs(as.numeric(coef(res_la, s = "lambda.min"))[-1]), 
                    effect_idx = causal_vars) +
  ylab("|coefficients|")
```

